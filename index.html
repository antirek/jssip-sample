<html>
  <head>
    <script src="./jssip.js" type="text/javascript"></script>
  </head>
  <body>
    <audio id="audio"></audio>

    <button onclick="connect()">connect</button>
    <button onclick="call()">call</button>

    <script lang="javascript">

      var ua;
      function call() {
        var eventHandlers = {
          'progress': function(e) {
            console.log('call is in progress', e);
          },
          'failed': function(e) {
            console.log('call failed with cause: ', e);
          },
          'ended': function(e) {
            console.log('call ended with cause: ', e);
          },
          'confirmed': function(e) {
            console.log('call confirmed', e);
          }
        };
        var options = {
          'eventHandlers'    : eventHandlers,
          'mediaConstraints' : { 'audio': true, 'video': false },
          'pcConfig': {
            'iceServers': [
              {'urls': ['stun:stun.stunprotocol.org:3478']},
              {'urls': ['stun:stun.l.google.com:19302']}
            ],
          },
        };
        console.log('call');
        var session = ua.call('sip:1002@62.109.24.81', options);
      }

      function connect() {
        var socket = new JsSIP.WebSocketInterface('wss://serge.dmitriev.fvds.ru:7443');
        var configuration = {
          sockets: [ socket ],
          uri: 'sip:1000@62.109.24.81',
          password : 'regity',
          register: true,
          register_expires: 120,
        };

        ua = new JsSIP.UA(configuration);

        ua.start();
        ua.on('newRTCSession', function(data){ 
          console.log('new session', data);

          var callOptions = {
            mediaConstraints: {
              audio: true, // only audio calls
              video: false
            },
            'pcConfig': {
              'iceServers': [
                {'urls': ['stun:stun.stunprotocol.org:3478']},
                {'urls': ['stun:stun.l.google.com:19302']}
              ],
            },
          };

          var session = data.session; 
          console.log('session', session, session.direction);
          if (session.direction === "incoming") {
              // incoming call here
              session.on("accepted",function(){
                // the call has answered
                console.log('accepted');
              });
              session.on("confirmed",function(){
                // this handler will be called for incoming calls too
                console.log('confirmed');
              });
              session.on("ended",function(){
                  // the call has ended
                  console.log('ended');
              });
              session.on("failed",function(){
                  // unable to establish the call
                  console.log('failed');
              });
              session.on('peerconnection', function(data) {
                console.log('peerconnection', data);
                var remoteStream = data.peerconnection.getRemoteStreams()[0];
                console.log('remote stream', remoteStream);
                var remoteAudio = document.getElementById('audio');
                remoteAudio.srcObject = remoteStream;


                /*
                data.peerconnection.addEventListener('addstream', function (e) {
                  // set remote audio stream
                  console.log('e', e);
                  var remoteAudio = document.getElementById('audio');
                  console.log('remote audio', remoteAudio);
                  // var remoteAudio = document.createElement('audio');
                  remoteAudio.srcObject = e.stream;
                  remoteAudio.play();
                });
                */
              });
              
              // Answer call
              session.answer(callOptions);
              
              // Reject call (or hang up it)
              // session.terminate();
          }
        });
      }
    </script>
  </body>
</html>


